{% extends "base.html" %}

{% block title %}Pay Invoice - Payment Splitter DApp{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0">
                <h4 class="card-title mb-0">
                    <i class="fas fa-credit-card text-primary me-2"></i>
                    Pay Invoice
                </h4>
                <p class="text-muted mb-0 mt-2">Contribute to a payment split</p>
            </div>
            <div class="card-body">
                <form id="pay-invoice-form" method="POST" class="needs-validation" novalidate>
                    <div class="mb-4">
                        <div class="mb-3">
                            <label for="payment_id" class="form-label">Payment ID</label>
                            <input type="number" class="form-control" id="payment_id" name="payment_id" 
                                   placeholder="Enter the payment ID" required min="0">
                            <div class="invalid-feedback">
                                Please enter a valid payment ID
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Get the payment ID from the person who created the payment split
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount to Pay (CELO)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="amount" name="amount" 
                                       step="0.0001" min="0.0001" placeholder="0.05" required>
                                <span class="input-group-text">CELO</span>
                            </div>
                            <div class="invalid-feedback">
                                Please enter a valid amount greater than 0
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Enter the amount you want to contribute to this payment split
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-paper-plane me-2"></i>
                            Pay Invoice
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            Back to Dashboard
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Payment Info Section -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-white border-0">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    How to pay an invoice
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-3">
                        <div class="feature-icon bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-search text-primary"></i>
                        </div>
                        <h6>1. Get Payment ID</h6>
                        <p class="text-muted small">Ask the payment creator for the payment ID</p>
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="feature-icon bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-credit-card text-success"></i>
                        </div>
                        <h6>2. Enter Amount</h6>
                        <p class="text-muted small">Enter how much you want to contribute</p>
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="feature-icon bg-info bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-check-circle text-info"></i>
                        </div>
                        <h6>3. Confirm Payment</h6>
                        <p class="text-muted small">Your contribution will be recorded on the blockchain</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Payments -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-white border-0">
                <h6 class="card-title mb-0">
                    <i class="fas fa-clock text-warning me-2"></i>
                    Recent Payments
                </h6>
            </div>
            <div class="card-body">
                <div id="recent-payments" class="row">
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading recent payments...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load recent payments when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadRecentPayments();
});

function loadRecentPayments() {
    fetch('/api/payments')
        .then(response => response.json())
        .then(data => {
            updateRecentPayments(data);
        })
        .catch(error => {
            console.error('Error loading payments:', error);
            document.getElementById('recent-payments').innerHTML = `
                <div class="col-12 text-center py-4">
                    <i class="fas fa-exclamation-triangle text-warning fa-2x mb-2"></i>
                    <p class="text-muted">Error loading payments</p>
                </div>
            `;
        });
}

function updateRecentPayments(payments) {
    const container = document.getElementById('recent-payments');
    
    if (payments.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-4">
                <i class="fas fa-inbox text-muted fa-2x mb-2"></i>
                <p class="text-muted">No payments available</p>
            </div>
        `;
        return;
    }
    
    // Show only active payments
    const activePayments = payments.filter(p => p.is_active).slice(0, 3);
    
    if (activePayments.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-4">
                <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                <p class="text-muted">No active payments available</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = activePayments.map(payment => `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">${payment.description}</h6>
                        <span class="badge bg-success">Active</span>
                    </div>
                    <p class="text-muted small mb-2">ID: ${payment.id}</p>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">Progress</small>
                            <small class="text-muted">${payment.progress.toFixed(1)}%</small>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" role="progressbar" style="width: ${payment.progress}%"></div>
                        </div>
                    </div>
                    <div class="row text-center">
                        <div class="col-6">
                            <small class="text-muted d-block">Total</small>
                            <strong>${payment.total_amount.toFixed(4)} CELO</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block">Collected</small>
                            <strong>${payment.collected_amount.toFixed(4)} CELO</strong>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-primary btn-sm w-100" 
                                onclick="fillPaymentForm(${payment.id})">
                            <i class="fas fa-credit-card me-1"></i>Pay This Invoice
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function fillPaymentForm(paymentId) {
    document.getElementById('payment_id').value = paymentId;
    document.getElementById('payment_id').focus();
    
    // Show success message
    showSuccess(`Payment ID ${paymentId} filled in! Enter your contribution amount.`);
}
</script>
{% endblock %}

